import os
from semantic_kernel.kernel import Kernel

class MicroserviceReviewPlugin:
    def __init__(self, kernel: Kernel, code_dir: str):
        self.kernel = kernel
        self.code_dir = code_dir

    def read_code_files(self):
        """Äá»c toÃ n bá»™ mÃ£ nguá»“n trong thÆ° má»¥c chá»‰ Ä‘á»‹nh."""
        code_snippets = []
        for root, _, files in os.walk(self.code_dir):
            for file in files:
                if file.endswith(('.py', '.js', '.ts', '.go', '.java', '.yaml', '.yml', '.json', 'Dockerfile')):
                    file_path = os.path.join(root, file)
                    try:
                        with open(file_path, 'r', encoding='utf-8') as f:
                            code_snippets.append(f"### {file} ###\n{f.read()}\n")
                    except Exception as e:
                        print(f"âš ï¸ KhÃ´ng thá»ƒ Ä‘á»c file {file_path}: {e}")
        return "\n".join(code_snippets[:10000])  # Giá»›i háº¡n dá»¯ liá»‡u gá»­i lÃªn AI

    async def analyze_architecture(self, code_content: str):
        """PhÃ¢n tÃ­ch mÃ£ nguá»“n Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ kiáº¿n trÃºc microservices."""
        prompt = f"""
        You are an expert in Microservices Architecture. Analyze the provided source code based on these key areas:

        ## ğŸ”„ Inter-Service Communication:
        - Identify communication patterns (REST, gRPC, Message Queue, WebSocket).
        - Check for possible latency issues.

        ## âš–ï¸ Load Balancing:
        - Review API Gateway and Load Balancer settings.
        - Detect inefficient traffic routing.

        ## ğŸ› ï¸ Fault Tolerance:
        - Check retry policies, circuit breakers, and failover mechanisms.

        ## ğŸ”— Service Dependencies:
        - Identify risks of cascading failures.
        - Evaluate service health checks.

        **Source Code for Analysis:**
        {code_content}

        ğŸ“Œ Provide a structured review with strengths, weaknesses, and improvement suggestions.
        """
        response = await self.kernel.invoke_prompt(prompt)
        return response.text if response else "âŒ No response from AI."

    async def review_microservices(self):
        """Cháº¡y Ä‘Ã¡nh giÃ¡ microservices báº±ng cÃ¡ch Ä‘á»c code vÃ  gá»­i lÃªn AI."""
        code_content = self.read_code_files()
        if not code_content:
            return "âŒ No source code found for analysis."
        return await self.analyze_architecture(code_content)
